networks:
  default:
    name: ${DEV_NAMESPACE}_default

services:
  nginx_main:
    image: manhphucofficial/nginx:${NGINX_VERSION}-alpine-custom
    container_name: ${DEV_NAMESPACE}_nginx_main
    volumes:
      - "./shared:/shared"
      - "./etc/nginx:/etc/nginx/conf.d"
      - "./etc/ssl:/etc/ssl"
      - "${WWW_DIR}:/var/www/html"
      - "${NGINX_LOG_DIR}:/var/log/nginx"
    ports:
      - "${NGINX_HTTP_EXPOSING_PORT}:80"
      - "${NGINX_HTTPS_EXPOSING_PORT}:443"
    environment:
      NGINX_HOST: ${NGINX_HOST}
    networks:
      - default

  # ============================================================================
  # PHP Services
  # ============================================================================
  php72_fpm:
    image: manhphucofficial/php:7.2-fpm
    container_name: ${DEV_NAMESPACE}_php72_fpm
    volumes:
      - "./shared:/shared"
      - "${WWW_DIR}:/var/www/html"
      - "./etc/php72/php-custom.ini:/etc/php/7.2/fpm/conf.d/php-custom.ini"
    environment:
      - PHP_UPLOAD_MAX_FILEZISE=256M
      - PHP_POST_MAX_SIZE=256M
      - PHP_MEMORY_LIMIT=128M
      - PHP_MAX_EXECUTION_TIME=120
      - PHP_MAX_INPUT_TIME=90
    networks:
      - default

  php82_web:
    image: manhphucofficial/php82_web
    container_name: ${DEV_NAMESPACE}_php82_web
    volumes:
      - "./shared:/shared"
      - "${WWW_DIR}:/var/www/html"
      - "./etc/php82/php-custom.ini:/etc/php/8.2/fpm/conf.d/php-custom.ini"
      - "./etc/ssl/dev-srv.org.key:/etc/nginx/certs/dev-srv.org.key"
      - "./etc/ssl/dev-srv.org.bundle.crt:/etc/nginx/certs/dev-srv.org.crt"
    environment:
      - PHP_UPLOAD_MAX_FILEZISE=256M
      - PHP_POST_MAX_SIZE=256M
      - PHP_MEMORY_LIMIT=128M
      - PHP_MAX_EXECUTION_TIME=120
      - PHP_MAX_INPUT_TIME=90
    networks:
      - default

  php_latest_fpm:
    image: manhphucofficial/php:latest-fpm
    container_name: ${DEV_NAMESPACE}_php_latest_fpm
    volumes:
      - "./shared:/shared"
      - "${WWW_DIR}:/var/www/html"
      - "./etc/php-latest/php-custom.ini:/etc/php/7.4/fpm/conf.d/php-custom.ini"
    environment:
      - PHP_UPLOAD_MAX_FILEZISE=256M
      - PHP_POST_MAX_SIZE=256M
      - PHP_MEMORY_LIMIT=128M
      - PHP_MAX_EXECUTION_TIME=120
      - PHP_MAX_INPUT_TIME=90
    networks:
      - default

  # ============================================================================
  # Python Services
  # ============================================================================
  python310_web:
    image: manhphucofficial/python:3.10-web
    container_name: ${DEV_NAMESPACE}_python310_web
    volumes:
      - "./shared:/shared"
      - "${WWW_DIR}:/var/www/html"
      - "${PYTHON_LOG_DIR}:/var/log/python"
    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
      - TZ=Asia/Ho_Chi_Minh
    working_dir: /var/www/html
    command: tail -f /dev/null
    networks:
      - default

  python311_web:
    image: manhphucofficial/python:3.11-web
    container_name: ${DEV_NAMESPACE}_python311_web
    volumes:
      - "./shared:/shared"
      - "${WWW_DIR}:/var/www/html"
      - "${PYTHON_LOG_DIR}:/var/log/python"
    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
      - TZ=Asia/Ho_Chi_Minh
    working_dir: /var/www/html
    command: tail -f /dev/null
    networks:
      - default

  python312_web:
    image: manhphucofficial/python:3.12-web
    container_name: ${DEV_NAMESPACE}_python312_web
    volumes:
      - "./shared:/shared"
      - "${WWW_DIR}:/var/www/html"
      - "${PYTHON_LOG_DIR}:/var/log/python"
    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
      - TZ=Asia/Ho_Chi_Minh
    working_dir: /var/www/html
    command: tail -f /dev/null
    networks:
      - default

  python_latest_web:
    image: manhphucofficial/python:latest-web
    container_name: ${DEV_NAMESPACE}_python_latest_web
    volumes:
      - "./shared:/shared"
      - "${WWW_DIR}:/var/www/html"
      - "${PYTHON_LOG_DIR}:/var/log/python"
    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
      - TZ=Asia/Ho_Chi_Minh
    working_dir: /var/www/html
    command: tail -f /dev/null
    networks:
      - default

  # ============================================================================
  # Database Services
  # ============================================================================
  mariadb:
    image: mariadb:${MARIADB_TAG}
    environment:
      - MYSQL_DATABASE=${MYSQL_DATABASE}
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_USER=${MYSQL_USER}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
    ports:
      - "${MYSQL_EXPOSING_PORT}:3306"
    volumes:
      - type: volume
        source: mariadb-data
        target: /var/lib/mysql
    networks:
      - default

  # ============================================================================
  # Admin Tools
  # ============================================================================
  adminer:
    image: adminer:4.7.7
    volumes:
      - "./etc/adminer/0-upload_large_dumps.ini:/usr/local/etc/php/conf.d/0-upload_large_dumps.ini"
    ports:
      - ${ADMINIER_WEB_EXPOSING_PORT}:8080
    environment:
      ADMINER_DESIGN: 'nette'
    networks:
      - default

  phpmyadmin:
    image: phpmyadmin/phpmyadmin
    ports:
      - "${PHPMYADMIN_WEB_EXPOSING_PORT}:80"
    environment:
      - PMA_ARBITRARY=1
      - PHP_UPLOAD_MAX_FILESIZE=1G
      - PHP_POST_MAX_SIZE=1G
      - PHP_MEMORY_LIMIT=0
      - PHPMYADMIN_ALLOW_ARBITRARY_SERVER=yes
      - PHP_MAX_INPUT_VARS=1G
      - UPLOAD_LIMIT=1G
    networks:
      - default

  # ============================================================================
  # Cache Services
  # ============================================================================
  ssdb:
    image: benyoo/ssdb
    volumes:
      - "./etc/ssdb/ssdb.conf:/etc/ssdb.conf"
    networks:
      - default

  phpssdbadmin:
    build:
      context: "./build/phpssdbadmin"
    ports:
      - "${PHPSSDBADMIN_WEB_EXPOSING_PORT}:80"
    networks:
      - default

  redis:
    image: redis
    ports:
      - "${REDIS_EXPOSING_PORT}:6379"
    volumes:
      - "./etc/redis/redis.conf:/usr/local/etc/redis/redis.conf"
    networks:
      - default

  phpredisadmin:
    image: erikdubbelboer/phpredisadmin
    ports:
      - "${PHPREDISADMIN_WEB_EXPOSING_PORT}:80"
    links:
      - redis
    environment:
      - ADMIN_USER=${REDIS_ADMIN_USER}
      - ADMIN_PASS=${REDIS_ADMIN_PASS}
      - REDIS_1_HOST=redis
      - REDIS_1_PORT=6379
    networks:
      - default

  # ============================================================================
  # Search Services
  # ============================================================================
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:7.7.0
    environment:
      - discovery.type=single-node
      - bootstrap.memory_lock=true
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - es-data:/usr/share/elasticsearch/data
    ports:
      - "9200:9200"
    networks:
      - default

volumes:
  mariadb-data:
    driver: local
  es-data:
    driver: local